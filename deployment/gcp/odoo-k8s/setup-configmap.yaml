apiVersion: v1
kind: ConfigMap
metadata:
  name: setup-script
data:
  setup.sh: |
    #!/bin/bash
    set -e
    echo "â³ Waiting for PostgreSQL to be ready..."
    until pg_isready -U postgres; do sleep 2; done
    echo "âœ… PostgreSQL is ready."
    echo "ğŸ”§ Creating role 'odoo' if missing..."
    psql -U postgres <<EOF
    DO \$\$
    BEGIN
       IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'odoo') THEN
          CREATE ROLE odoo WITH LOGIN PASSWORD 'odoo' CREATEDB INHERIT;
       END IF;
    END
    \$\$;
    EOF
    echo "ğŸ”§ Creating database 'it2025' if missing..."
    psql -U postgres -tc "SELECT 1 FROM pg_database WHERE datname = 'it2025'" | grep -q 1 || \
      psql -U postgres -c "CREATE DATABASE it2025 OWNER odoo"
    echo "ğŸ“¦ Restoring dump into 'it2025'..."
    pg_restore -U postgres -d it2025 /docker-entrypoint-initdb.d/it2025.dump || {
      echo "âŒ pg_restore failed!"
      exit 1
    }
    echo "âœ… Database restore complete."
