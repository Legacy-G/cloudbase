## Step-by-Step: Deploy Odoo 18 Stack to GCP

### Step 1: Prepare Environment

1. **Create a GCP Project**
   - Go to [GCP Console](https://console.cloud.google.com/)
   - Create a new project (e.g., `futminna-odoo-stack`)

2. **Enable Required APIs**
   - Cloud Run
   - Artifact Registry
   - Cloud SQL
   - Compute Engine
   - Kubernetes Engine (if using GKE)

3. **Install Google Cloud SDK**
   ```bash
   curl https://sdk.cloud.google.com | bash
   gcloud init
   ```

---

### Step 2: Push Your Image to GCP Artifact Registry

1. **Create Artifact Registry**
   ```bash
   gcloud artifacts repositories create odoo-repo \
     --repository-format=docker \
     --location=us-central1 \
     --description="Odoo 18 image repo"
   ```

2. **Tag and Push Your Image**
   ```bash
   docker tag legacyg/dbms-itcloud-image:odoo18-futminna \
     us-central1-docker.pkg.dev/futminna-odoo-stack/odoo-repo/odoo18-futminna

   docker push us-central1-docker.pkg.dev/futminna-odoo-stack/odoo-repo/odoo18-futminna
   ```

---

### Step 3: Set Up PostgreSQL in Cloud SQL

1. **Create Cloud SQL Instance**
   - PostgreSQL 17
   - Set root password
   - Enable public IP (or use private IP with VPC connector)

2. **Import `it2025.dump`**
   - Upload to Cloud Storage
   - Use `gcloud sql import`:
     ```bash
     gcloud sql import sql <INSTANCE_NAME> gs://<BUCKET_NAME>/it2025.dump \
       --database=it2025
     ```

3. **Create `odoo` Role**
   - Connect via `psql` or Cloud SQL editor
   ```sql
   CREATE ROLE odoo WITH LOGIN PASSWORD 'odoo' CREATEDB;
   ```

---

### ðŸ”¹ Step 4: Deploy Odoo to Cloud Run or GKE

#### Option A: Cloud Run (simpler, auto-scaling)

1. **Deploy Odoo Container**
   ```bash
   gcloud run deploy odoo-service \
     --image=us-central1-docker.pkg.dev/futminna-odoo-stack/odoo-repo/odoo18-futminna \
     --platform=managed \
     --region=us-central1 \
     --allow-unauthenticated \
     --set-env-vars HOST=<CLOUD_SQL_HOST>,USER=odoo,PASSWORD=odoo
   ```

2. **Connect to Cloud SQL**
   - Use [Cloud SQL Proxy](https://cloud.google.com/sql/docs/postgres/connect-run)
   - Add connection string to `odoo.conf`

#### Option B: GKE (for advanced scaling)

1. **Create GKE Cluster**
   ```bash
   gcloud container clusters create odoo-cluster \
     --num-nodes=3 \
     --zone=us-central1-a
   ```

2. **Deploy with Kubernetes YAML**
   - Use `Deployment`, `Service`, and `ConfigMap`
   - Mount `odoo.conf` and connect to Cloud SQL via private IP

---

### Step 5: Fix Networking Error

**Error:** `could not translate host name "db" to address`

**Fix:**
- In cloud deployments, `db` is not automatically resolvable
- Replace `HOST=db` with actual Cloud SQL IP or connection name
  ```ini
  db_host = <CLOUD_SQL_IP>
  db_port = 5432
  db_user = odoo
  db_password = odoo
  ```

---

### ðŸ”¹ Step 6: Scale for 30,000+ Users

1. **Use Cloud Run with max concurrency set**
   ```bash
   gcloud run services update odoo-service \
     --concurrency=100 \
     --cpu=2 \
     --memory=2Gi
   ```

2. **Enable Autoscaling**
   - Set min/max instances
   - Use load balancer if needed

3. **Optimize PostgreSQL**
   - Increase `max_connections`, `work_mem`, `shared_buffers`
   - Use read replicas if needed

---

### ðŸ”¹ Step 7: Monitor and Tune

- Use **Cloud Monitoring** and **Cloud Trace**
- Enable **SQL Insights** for query performance
- Use **Cloud Armor** for security and rate limiting

---

## Summary

| Component       | Tool/Service Used                     |
|----------------|----------------------------------------|
| Odoo Image      | Docker + Artifact Registry             |
| Database        | PostgreSQL 17 on Cloud SQL             |
| Deployment      | Cloud Run or GKE                       |
| Scaling         | Autoscaling + Load Balancer            |
| Networking Fix  | Replace `db` with actual IP/hostname   |
| Monitoring      | Cloud Monitoring + SQL Insights        |
